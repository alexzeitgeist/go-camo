<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Go-camo by cactus</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/cactus/go-camo">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/cactus/go-camo/releases">Releases</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Go-camo</h1>
          <p>Go version of Camo server.</p>
          <hr>
        </div>


<h2>
<a id="about" class="anchor" href="#about" aria-hidden="true"><span class="octicon octicon-link"></span></a>About</h2>

<p>Go-camo is a Go version of <a href="https://github.com/atmos/camo">Camo</a> server.</p>

<p><a href="https://github.com/atmos/camo">Camo</a> is a special type of image proxy that proxies non-secure images over
SSL/TLS. This prevents mixed content warnings on secure pages.</p>

<p>It works in conjunction with back-end code to rewrite image URLs and sign them
with an <a href="http://en.wikipedia.org/wiki/HMAC">HMAC</a>.</p>

<h2>
<a id="how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span class="octicon octicon-link"></span></a>How it works</h2>

<p>First you parse the original URL, generate an HMAC signature of it, then encode
it, and then place the pieces into the expected format replacing the original
image URL.</p>

<p>The client requests the generated URL from Go-Camo. Go-Camo validates the HMAC, decodes the URL, then requests the content and streams it to the client.</p>


<pre><code>+----------+           request            +-------------+
|          |----------------------------->|             |
|          |                              |             |
|          |                              |   web-app   |
|          | img src=https://go-camo/url  |             |
|          |<-----------------------------|             |
|          |                              +-------------+
|  client  |
|          |     https://go-camo/url      +-------------+ http://some/img
|          |----------------------------->|             |--------------->
|          |                              |             |
|          |                              |   go-camo   |
|          |           img data           |             |    img data
|          |<-----------------------------|             |<---------------
|          |                              +-------------+
+----------+
</code></pre>

<p>Go-Camo supports both hex and base64 encoded urls at the same time.</p>

<table>
<thead>
<tr>
<th>encoding</th>
<th>tradeoffs</th>
</tr>
</thead>
<tbody>
<tr>
<td>hex</td>
<td>longer, case insensitive, slightly faster (<em>pre go1.6</em>)</td>
</tr>
<tr>
<td>base64</td>
<td>shorter, case sensitive, slightly slower (<em>pre go1.6</em>)</td>
</tr>
</tbody>
</table>

<p><strong>NOTE</strong>: As of go1.6 base64 is very close to hex in terms of
performance.</p>

<pre><code>BenchmarkHexEncoder-2             500000          3027 ns/op
BenchmarkB64Encoder-2             500000          3234 ns/op
BenchmarkHexDecoder-2             500000          3609 ns/op
BenchmarkB64Decoder-2             500000          3495 ns/op
</code></pre>

<p>For examples of url generation, see the <a href="examples/">examples</a> directory.</p>

<p>While Go-Camo will support proxying HTTPS images as well, for performance
reasons you may choose to filter HTTPS requests out from proxying, and let the
client simply fetch those as they are. The linked code examples do this.</p>

<p>Note that it is recommended to front Go-Camo with a CDN when possible.</p>

<h2>
<a id="differences-from-camo" class="anchor" href="#differences-from-camo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Differences from Camo</h2>

<ul>
<li>  Go-Camo supports 'Path Format' url format only. Camo's "Query
String Format" is not supported.</li>
<li>  Go-Camo supports "allow regex host filters".</li>
<li>  Go-Camo supports client http keep-alives.</li>
<li>  Go-Camo provides native SSL support.</li>
<li>  Go-Camo provides native HTTP/2 support (if built using &gt;=go1.6).</li>
<li>  Go-Camo supports using more than one os thread (via GOMAXPROCS) without the
need of multiple instances or additional proxying.</li>
<li>  Go-Camo builds to a static binary. This makes deploying to large numbers
of servers a snap.</li>
<li>  Go-Camo supports both Hex and Base64 urls. Base64 urls are smaller, but
case sensitive.</li>
<li>  Go-Camo supports HTTP HEAD requests.</li>
<li>  Go-Camo allows custom default headers to be added -- useful for things
like adding <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">HSTS</a> headers.</li>
</ul>

<h2>
<a id="installing-pre-build-binaries" class="anchor" href="#installing-pre-build-binaries" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installing pre-build binaries</h2>

<p>Download the tarball appropriate for your OS/ARCH from <a href="https://github.com/cactus/go-camo/releases">releases</a>.
Extract, and copy files to desired locations.</p>

<h2>
<a id="building" class="anchor" href="#building" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building</h2>

<p>Building requires:</p>
<pre><code>* git
* make
* go (version >= 1.4 required, 1.6 recommended) 
</code></pre>

<p>Building:</p>

<pre><code># show make targets
$ make
Available targets:
  help                this help
  clean               clean up
  all                 build binaries and man pages
  test                run tests
  cover               run tests with cover output
  build-setup         fetch dependencies
  build               build all
  man                 build all man pages
  tar                 build release tarball
  cross-tar           cross compile and build release tarballs

# fetch vendor dependencies
$ make build-setup

# build all binaries and man pages
$ make all

# as an alternative to the previous command, build and strip debug symbols.
# this is useful for production, and reduces the resulting file size.
$ make all GOBUILD_LDFLAGS="-s"
</code></pre>

<p>By default, Go-Camo builds with <code>-tags netgo</code>. However, depending on your Go version, this will not actually result in Go-Camo using the netgo resolver unless your Go stdlib is similarly compiled. There are <a href="https://github.com/cactus/go-camo/issues/6">known</a> issues with using the libc resolver with significant traffic amounts over time. The use of netgo is recommended. Prior to Go 1.5, to recompile your Go net libraries to use netgo, do the following as root (or the owner of your GOROOT install) before building Go-Camo:</p>

<pre><code>$ go clean -i net
$ go install -a -tags netgo std
</code></pre>

<p>To confirm that you are using the netgo resolver:</p>

<pre><code>$ make build
$ ldd bin/go-camo
not a dynamic executable
</code></pre>

<p>If you are using the libc resolver, you will see something like this instead:</p>

<pre><code>$ make build
$ ldd bin/go-camo
linux-vdso.so.1 =&gt;  (0x00007fff98fff000)
libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x0000003fb2a00000)
libc.so.6 =&gt; /lib64/libc.so.6 (0x0000003fb2600000)
/lib64/ld-linux-x86-64.so.2 (0x0000003fb2200000)
</code></pre>

<h2>
<a id="running" class="anchor" href="#running" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running</h2>

<pre><code>$ go-camo -k "somekey"
</code></pre>

<p>Go-Camo does not daemonize on its own. For production usage, it is recommended
to launch in a process supervisor, and drop privileges as appropriate.</p>

<p>Examples of supervisors include: <a href="http://cr.yp.to/daemontools.html">daemontools</a>, <a href="http://smarden.org/runit/">runit</a>, <a href="http://upstart.ubuntu.com/">upstart</a>,
<a href="http://launchd.macosforge.org/">launchd</a>, and many more.</p>

<p>For the reasoning behind lack of daemonization, see <a href="http://cr.yp.to/daemontools/faq/create.html#why">daemontools/why</a>. In
addition, the code is much simpler because of it.</p>

<h2>
<a id="running-on-heroku" class="anchor" href="#running-on-heroku" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running on Heroku</h2>

<p>In order to use this on Heroku with the provided Procfile, you need to:</p>

<ol>
<li> Create an app specifying the <a href="https://github.com/kr/heroku-buildpack-go">https://github.com/kr/heroku-buildpack-go</a>
buildpack</li>
<li> Set <code>HMAC_KEY</code> to the key you are using</li>
</ol>

<h2>
<a id="configuring" class="anchor" href="#configuring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring</h2>

<h3>
<a id="environment-vars" class="anchor" href="#environment-vars" aria-hidden="true"><span class="octicon octicon-link"></span></a>Environment Vars</h3>

<ul>
<li>  <code>GOCAMO_HMAC</code> - HMAC key to use.</li>
</ul>

<h3>
<a id="command-line-flags" class="anchor" href="#command-line-flags" aria-hidden="true"><span class="octicon octicon-link"></span></a>Command line flags</h3>

<pre><code>$ go-camo -h
Usage:
  go-camo [OPTIONS]

Application Options:
  -k, --key=           HMAC key
  -H, --header=        Extra header to return for each response. This option
                       can be used multiple times to add multiple headers
      --stats          Enable Stats
      --allow-list=    Text file of hostname allow regexes (one per line)
      --max-size=      Max response image size (KB) (5120)
      --timeout=       Upstream request timeout (4s)
      --max-redirects= Maximum number of redirects to follow (3)
      --no-fk          Disable frontend http keep-alive support
      --no-bk          Disable backend http keep-alive support
      --listen=        Address:Port to bind to for HTTP (0.0.0.0:8080)
      --ssl-listen=    Address:Port to bind to for HTTPS/SSL/TLS
      --ssl-key=       ssl private key (key.pem) path
      --ssl-cert=      ssl cert (cert.pem) path
  -v, --verbose        Show verbose (debug) log level output
  -V, --version        print version and exit

Help Options:
  -h, --help          Show this help message
</code></pre>

<p>If an allow-list file is defined, that file is read and each line converted
into a hostname regex. If a request does not match one of the listed host
regex, then the request is denied.</p>

<p>If stats flag is provided, then the service will track bytes and clients
served, and offer them up at an http endpoint <code>/status</code> via HTTP GET request.</p>

<p>If the HMAC key is provided on the command line, it will override (if present),
an HMAC key set in the environment var.</p>

<p>Additional default headers (headers sent on every reply) can also be set. The
<code>-H, --header</code> argument may be specified many times.</p>

<p>The list of default headers sent are:</p>

<pre><code>X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'none'`
</code></pre>

<p>As an example, if you wanted to return a <code>Strict-Transport-Security</code> header
by default, you could add this to the command line:</p>

<pre><code>-H "Strict-Transport-Security:  max-age=16070400"
</code></pre>

<h2>
<a id="additional-tools" class="anchor" href="#additional-tools" aria-hidden="true"><span class="octicon octicon-link"></span></a>Additional tools</h2>

<p>Go-Camo includes a couple of additional tools.</p>

<h3>
<a id="url-tool" class="anchor" href="#url-tool" aria-hidden="true"><span class="octicon octicon-link"></span></a>url-tool</h3>

<p>The <code>url-tool</code> utility provides a simple way to generate signed URLs from the command line.</p>

<pre><code>$ url-tool -h
Usage:
  url-tool [OPTIONS] &lt;decode | encode&gt;

Application Options:
  -k, --key=    HMAC key
  -p, --prefix= Optional url prefix used by encode output

Help Options:
  -h, --help    Show this help message

Available commands:
  decode  Decode a url and print result
  encode  Encode a url and print result
</code></pre>

<p>Example usage:</p>

<pre><code># hex
$ url-tool -k "test" encode -p "https://img.example.org" "http://golang.org/doc/gopher/frontpage.png"
https://img.example.org/0f6def1cb147b0e84f39cbddc5ea10c80253a6f3/687474703a2f2f676f6c616e672e6f72672f646f632f676f706865722f66726f6e74706167652e706e67

$ url-tool -k "test" decode "https://img.example.org/0f6def1cb147b0e84f39cbddc5ea10c80253a6f3/687474703a2f2f676f6c616e672e6f72672f646f632f676f706865722f66726f6e74706167652e706e67"
http://golang.org/doc/gopher/frontpage.png

# base64
$ url-tool -k "test" encode -b base64 -p "https://img.example.org" "http://golang.org/doc/gopher/frontpage.png"
https://img.example.org/D23vHLFHsOhPOcvdxeoQyAJTpvM/aHR0cDovL2dvbGFuZy5vcmcvZG9jL2dvcGhlci9mcm9udHBhZ2UucG5n

$ url-tool -k "test" decode "https://img.example.org/D23vHLFHsOhPOcvdxeoQyAJTpvM/aHR0cDovL2dvbGFuZy5vcmcvZG9jL2dvcGhlci9mcm9udHBhZ2UucG5n"
http://golang.org/doc/gopher/frontpage.png
</code></pre>

<h3>
<a id="simple-server" class="anchor" href="#simple-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>simple-server</h3>

<p>The <code>simple-server</code> utility is useful for testing. It serves the contents of a
given directory over http. Nothing more.</p>

<pre><code>$ simple-server -h
Usage:
  simple-server [OPTIONS] DIR

Application Options:
  -l, --listen= Address:Port to bind to for HTTP (0.0.0.0:8000)

Help Options:
  -h, --help    Show this help message
</code></pre>

<h2>
<a id="changelog" class="anchor" href="#changelog" aria-hidden="true"><span class="octicon octicon-link"></span></a>Changelog</h2>

<p>See <a href="https://github.com/cactus/go-camo/blob/master/CHANGELOG.md">CHANGELOG.md</a></p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT
license</a>. See <a href="https://github.com/cactus/go-camo/blob/master/LICENSE.md">LICENSE.md</a> file for details.</p>
        <div id="footer">
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/cactus">cactus</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>
      </section>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
